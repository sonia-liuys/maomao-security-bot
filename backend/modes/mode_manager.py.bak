#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
æ¨¡å¼ç®¡ç†å™¨ - æ§åˆ¶æ©Ÿå™¨äººçš„ä¸åŒé‹è¡Œæ¨¡å¼
Mode Manager - Controls different operating modes of the robot
"""

import logging
import time
from enum import Enum, auto
import random
import os
from utils.audio_player import play_sound

# å®šç¾©ANSIé¡è‰²ä»£ç¢¼ç”¨æ–¼å½©è‰²æ—¥èªŒè¼¸å‡º
# Define ANSI color codes for colored log output
COLORS = {
    'RESET': '\033[0m',
    'RED': '\033[91m',
    'GREEN': '\033[92m',
    'YELLOW': '\033[93m',
    'BLUE': '\033[94m',
    'MAGENTA': '\033[95m',
    'CYAN': '\033[96m',
    'WHITE': '\033[97m',
    'BOLD': '\033[1m'
}

class RobotMode(Enum):
    """æ©Ÿå™¨äººé‹è¡Œæ¨¡å¼æšèˆ‰"""
    MANUAL = auto()       # æ‰‹å‹•æ¨¡å¼
    PATROL = auto()       # å·¡é‚æ¨¡å¼
    SURVEILLANCE = auto() # ç›£è¦–æ¨¡å¼

class ModeManager:
    """æ©Ÿå™¨äººæ¨¡å¼ç®¡ç†å™¨ï¼Œè™•ç†ä¸åŒæ¨¡å¼çš„é‚è¼¯å’Œè½‰æ›"""
    
    def __init__(self, vision_system, servo_controller, movement_controller, config):
        """åˆå§‹åŒ–æ¨¡å¼ç®¡ç†å™¨
        
        Args:
            vision_system: è¦–è¦ºç³»çµ±å¯¦ä¾‹
            servo_controller: ä¼ºæœé¦¬é”æ§åˆ¶å™¨å¯¦ä¾‹
            movement_controller: ç§»å‹•æ§åˆ¶å™¨å¯¦ä¾‹
            config (dict): æ¨¡å¼é…ç½®
        """
        self.logger = logging.getLogger("ModeManager")
        self.vision_system = vision_system
        self.servo_controller = servo_controller
        self.movement_controller = movement_controller
        self.config = config
        
        self.current_mode = None
        self.mode_start_time = 0
        
        # æ¨¡å¼ç‰¹å®šç‹€æ…‹
        self.patrol_last_move_time = 0
        self.patrol_active = False  # æ·»åŠ å·¡é‚æ¨¡å¼æ´»å‹•ç‹€æ…‹
        self.surveillance_countdown = 0
        self.surveillance_intruder_detected = False
        self.student_id_detection_pause_until = 0
        self.alarm_active = False  # æ·»åŠ è­¦å ±ç‹€æ…‹å±¬æ€§
        self.websocket_server = None  # å°‡åœ¨RobotControllerä¸­è¨­ç½®
        
        # è¨­ç½®è­¦å ±éŸ³æ•ˆè·¯å¾‘
        # Set alarm sound file path
        script_dir = os.path.dirname(os.path.abspath(__file__))
        self.alarm_sound_path = os.path.join(script_dir, "../assets/sounds/alarm.wav")
        
        self.logger.info("æ¨¡å¼ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ")
    
    def set_mode(self, mode):
        """è¨­ç½®æ©Ÿå™¨äººé‹è¡Œæ¨¡å¼
        
        Args:
            mode (RobotMode): è¦è¨­ç½®çš„æ¨¡å¼
        """
        if self.current_mode == mode:
            self.logger.info(f"å·²ç¶“è™•æ–¼{mode.name}æ¨¡å¼ï¼Œç„¡éœ€åˆ‡æ›")
            return
            
        self.logger.info(f"åˆ‡æ›æ¨¡å¼: {self.current_mode} -> {mode}")
        
        # å¦‚æœç•¶å‰æœ‰æ´»å‹•æ¨¡å¼ï¼Œå…ˆé€€å‡º
        if self.current_mode:
            self._exit_mode(self.current_mode)
            
        # è¨­ç½®æ–°æ¨¡å¼
        self.current_mode = mode
        self.mode_start_time = time.time()
        
        # é€²å…¥æ–°æ¨¡å¼
        self._enter_mode(mode)
        
        self.logger.info(f"å·²åˆ‡æ›åˆ°{mode.name}æ¨¡å¼")
    
    def _enter_mode(self, mode):
        """é€²å…¥æŒ‡å®šæ¨¡å¼æ™‚çš„è™•ç†
        
        Args:
            mode (RobotMode): è¦é€²å…¥çš„æ¨¡å¼
        """
        # ä½¿ç”¨å½©è‰²æ—¥èªŒè¼¸å‡ºæ¨¡å¼åˆ‡æ›ä¿¡æ¯
        # Use colored log output for mode switching information
        mode_color = COLORS['CYAN']
        mode_name = mode.name
        self.logger.info(f"{COLORS['BOLD']}{mode_color}[MODE CHANGE] é€²å…¥{mode_name}æ¨¡å¼{COLORS['RESET']}")
        self.logger.info(f"{COLORS['BOLD']}{mode_color}[MODE CHANGE] Entering {mode_name} mode{COLORS['RESET']}")
        
        # æ¨¡å¼ç‰¹å®šåˆå§‹åŒ–
        if mode == RobotMode.MANUAL:
            # æ‰‹å‹•æ¨¡å¼ä¸‹å•Ÿå‹•è‡ªç„¶çœ¨çœ¼å’Œæ‰‹è‡‚æ“ºå‹•
            self.logger.info(f"{COLORS['BLUE']}[MANUAL] å•Ÿå‹•è‡ªç„¶çœ¨çœ¼å’Œæ‰‹è‡‚æ“ºå‹•{COLORS['RESET']}")
            self.servo_controller.start_natural_blinking()
            self.servo_controller.start_arm_swinging()
            
        elif mode == RobotMode.PATROL:
            # å·¡é‚æ¨¡å¼ä¸‹å•Ÿå‹•è‡ªå‹•å·¡é‚ï¼Œè¨­ç½®çœ¼ç›ç‚ºé»ƒè‰²ä¸”ä¸çœ¨çœ¼
            self.patrol_last_move_time = time.time()
            self.logger.info(f"{COLORS['YELLOW']}[PATROL] å•Ÿå‹•å·¡é‚æ¨¡å¼{COLORS['RESET']}")
            
            # åœæ­¢æ‰€æœ‰çœ¨çœ¼åŠŸèƒ½
            self.logger.info(f"{COLORS['YELLOW']}[PATROL] åœæ­¢æ‰€æœ‰çœ¨çœ¼åŠŸèƒ½{COLORS['RESET']}")
            self.servo_controller.stop_natural_blinking()
            self.servo_controller.stop_led_blinking()
            self.servo_controller.stop_eyelid_blinking()
            
            # è¨­ç½®çœ¼ç›é¡è‰²ç‚ºé»ƒè‰²
            self.logger.info(f"{COLORS['YELLOW']}[EYE COLOR] è¨­ç½®çœ¼ç›é¡è‰²ç‚ºé»ƒè‰²{COLORS['RESET']}")
            self.logger.info(f"{COLORS['YELLOW']}[EYE COLOR] Setting eye color to yellow{COLORS['RESET']}")
            self.servo_controller.set_eye_color("yellow")
            
        elif mode == RobotMode.SURVEILLANCE:
            # ç›£è¦–æ¨¡å¼ä¸‹æº–å‚™ç›£æ§
            self.logger.info(f"{COLORS['GREEN']}[SURVEILLANCE] å•Ÿå‹•ç›£è¦–æ¨¡å¼{COLORS['RESET']}")
            self.logger.info(f"{COLORS['GREEN']}[SURVEILLANCE] Starting surveillance mode{COLORS['RESET']}")
            pass
    
    def _exit_mode(self, mode):
        """é€€å‡ºæŒ‡å®šæ¨¡å¼æ™‚çš„è™•ç†
        
        Args:
            mode (RobotMode): è¦é€€å‡ºçš„æ¨¡å¼
        """
        # åœæ­¢æ‰€æœ‰é‹å‹•
        self.movement_controller.stop()
        
        # æ¨¡å¼ç‰¹å®šæ¸…ç†
        if mode == RobotMode.MANUAL:
            self.servo_controller.stop_natural_blinking()
            self.servo_controller.stop_arm_swinging()
    
    def update(self, vision_data):
        """æ›´æ–°ç•¶å‰æ¨¡å¼çš„ç‹€æ…‹
        
        Args:
            vision_data (dict): è¦–è¦ºç³»çµ±æä¾›çš„æœ€æ–°æ•¸æ“š
        """
        if not self.current_mode:
            return
            
        # æ ¹æ“šç•¶å‰æ¨¡å¼åŸ·è¡Œç›¸æ‡‰çš„æ›´æ–°é‚è¼¯
        if self.current_mode == RobotMode.MANUAL:
            self._update_manual_mode(vision_data)
        elif self.current_mode == RobotMode.PATROL:
            self._update_patrol_mode(vision_data)
        elif self.current_mode == RobotMode.SURVEILLANCE:
            self._update_surveillance_mode(vision_data)
    
    def _update_manual_mode(self, vision_data):
        """æ›´æ–°æ‰‹å‹•æ¨¡å¼
        
        Args:
            vision_data (dict): è¦–è¦ºç³»çµ±æä¾›çš„æœ€æ–°æ•¸æ“š
        """
        # æ‰‹å‹•æ¨¡å¼ä¸‹ï¼Œå¤§éƒ¨åˆ†æ“ä½œç”±ç”¨æˆ¶æ§åˆ¶
        # é€™è£¡å¯ä»¥æ·»åŠ ä¸€äº›è‡ªå‹•éŸ¿æ‡‰é‚è¼¯
        pass
    
    def _update_patrol_mode(self, vision_data):
        """æ›´æ–°å·¡é‚æ¨¡å¼
        
        Args:
            vision_data (dict): è¦–è¦ºç³»çµ±æä¾›çš„æœ€æ–°æ•¸æ“š
        """
        # å¦‚æœå·¡é‚æ¨¡å¼æœªå•Ÿå‹•ï¼Œå‰‡ä¸åŸ·è¡Œä»»ä½•æ“ä½œ
        if not self.patrol_active:
            return
            
        current_time = time.time()
        
        # æª¢æŸ¥æ˜¯å¦éœ€è¦ç§»å‹•
        # æ¯éš”ä¸€æ®µæ™‚é–“éš¨æ©Ÿé¸æ“‡ä¸€å€‹æ–¹å‘ç§»å‹•
        if current_time - self.patrol_last_move_time > 5.0:  # æ¯5ç§’ç§»å‹•ä¸€æ¬¡
            self.patrol_last_move_time = current_time
            
            # éš¨æ©Ÿé¸æ“‡ä¸€å€‹æ–¹å‘
            directions = ["forward", "backward", "left", "right"]
            direction = random.choice(directions)
            
            self.logger.info(f"å·¡é‚æ¨¡å¼: ç§»å‹•æ–¹å‘ {direction}")
            self.movement_controller.move(direction)
            
            # çŸ­æš«ç§»å‹•å¾Œåœæ­¢
            time.sleep(1.0)
            self.movement_controller.stop()
    
    def _update_surveillance_mode(self, vision_data):
        """æ›´æ–°ç›£è¦–æ¨¡å¼
        
        Args:
            vision_data (dict): è¦–è¦ºç³»çµ±æä¾›çš„æœ€æ–°æ•¸æ“š
        """
        # æª¢æŸ¥æ˜¯å¦æª¢æ¸¬åˆ°äººè‡‰
        face_detected = vision_data.get("face_detected", False)
        recognized_person = vision_data.get("recognized_person", "")
        confidence = vision_data.get("confidence", 0.0)
        
        # æª¢æŸ¥æ˜¯å¦éœ€è¦æš«åœå­¸ç”Ÿè­‰æª¢æ¸¬
        current_time = time.time()
        if current_time < self.student_id_detection_pause_until:
            # æš«åœå­¸ç”Ÿè­‰æª¢æ¸¬
            return
        
        # ç”¨å½©è‰²æ—¥èªŒè¼¸å‡ºäººè‡‰æª¢æ¸¬çµæœ
        # Use colored log output for face detection results
        if face_detected:
            if recognized_person and recognized_person != "unknown":
                self.logger.info(f"{COLORS['GREEN']}[FACE DETECTED] è­˜åˆ¥åˆ°å·²çŸ¥äººå“¡: {recognized_person}, ç½®ä¿¡åº¦: {confidence:.2f}{COLORS['RESET']}")
                self.logger.info(f"{COLORS['GREEN']}[FACE DETECTED] Recognized known person: {recognized_person}, confidence: {confidence:.2f}{COLORS['RESET']}")
            else:
                self.logger.info(f"{COLORS['RED']}[FACE DETECTED] è­˜åˆ¥åˆ°æœªçŸ¥äººå“¡, ç½®ä¿¡åº¦: {confidence:.2f}{COLORS['RESET']}")
                self.logger.info(f"{COLORS['RED']}[FACE DETECTED] Detected unknown person, confidence: {confidence:.2f}{COLORS['RESET']}")
            
        # å¦‚æœæª¢æ¸¬åˆ°äººè‡‰ä½†ä¸æ˜¯å·²çŸ¥äººå“¡
        if face_detected and (not recognized_person or recognized_person == "unknown"):
            if not self.surveillance_intruder_detected:
                self.logger.warning(f"{COLORS['BOLD']}{COLORS['RED']}[ALARM] ç›£è¦–æ¨¡å¼: æª¢æ¸¬åˆ°æœªçŸ¥äººå“¡{COLORS['RESET']}")
                self.logger.warning(f"{COLORS['BOLD']}{COLORS['RED']}[ALARM] Surveillance mode: Unknown person detected{COLORS['RESET']}")
                
                # è¨­ç½®çœ¼ç›é¡è‰²ç‚ºç´…è‰²
                self.logger.info(f"{COLORS['RED']}[EYE COLOR] è¨­ç½®çœ¼ç›é¡è‰²ç‚ºç´…è‰²{COLORS['RESET']}")
                self.logger.info(f"{COLORS['RED']}[EYE COLOR] Setting eye color to red{COLORS['RESET']}")
                self.servo_controller.set_eye_color("red")
                
                # å•Ÿå‹•è­¦å ±
                self.alarm_active = True
                self.logger.warning(f"{COLORS['RED']}[ALARM] å•Ÿå‹•è­¦å ±ç‹€æ…‹{COLORS['RESET']}")
                self.logger.warning(f"{COLORS['RED']}[ALARM] Activating alarm state{COLORS['RESET']}")
                
                # èˆ‰èµ·æ‰‹è‡‚
                self.logger.info(f"{COLORS['MAGENTA']}[ARM MOVEMENT] èˆ‰èµ·æ‰‹è‡‚{COLORS['RESET']}")
                self.logger.info(f"{COLORS['MAGENTA']}[ARM MOVEMENT] Raising arms{COLORS['RESET']}")
                self.servo_controller.raise_arms()
                
                # å•Ÿå‹•æ¿€å…‰
                self.logger.info(f"{COLORS['CYAN']}[LASER] å•Ÿå‹•æ¿€å…‰æŒ‡ç¤ºå™¨{COLORS['RESET']}")
                self.logger.info(f"{COLORS['CYAN']}[LASER] Activating laser pointer{COLORS['RESET']}")
                self.servo_controller.activate_laser()
                
                # æ’­æ”¾è­¦å ±è²
                self.logger.info(f"{COLORS['RED']}[ALARM] æ’­æ”¾è­¦å ±è²{COLORS['RESET']}")
                play_sound(self.alarm_sound_path)
                
                # è¨­ç½®å€’è¨ˆæ™‚
                self.surveillance_countdown = 10  # 10ç§’å€’è¨ˆæ™‚
                self.surveillance_intruder_detected = True
                self.logger.info(f"{COLORS['YELLOW']}[COUNTDOWN] é–‹å§‹10ç§’å€’è¨ˆæ™‚{COLORS['RESET']}")
                
                # å»£æ’­è­¦å ±æ¶ˆæ¯åˆ°å‰ç«¯
                message = {
                    "type": "recognition_result",
                    "data": {
                        "recognized": False,
                        "message": "æª¢æ¸¬åˆ°æœªçŸ¥äººå“¡",
                        "countdown": self.surveillance_countdown,
                        "confidence": confidence,
                        "emoji": "ğŸš¨",
                        "eye_color": "red"
                    }
                }
                
                # å¦‚æœæœ‰WebSocketæœå‹™å™¨å¯¦ä¾‹ï¼Œå»£æ’­è­˜åˆ¥çµæœ
                if hasattr(self, "websocket_server") and self.websocket_server:
                    self.logger.info(f"å»£æ’­è­¦å ±æ¶ˆæ¯åˆ°å‰ç«¯: {message}")
            
    current_time = time.time()
        
    # æª¢æŸ¥æ˜¯å¦éœ€è¦ç§»å‹•
    # æ¯éš”ä¸€æ®µæ™‚é–“éš¨æ©Ÿé¸æ“‡ä¸€å€‹æ–¹å‘ç§»å‹•
    if current_time - self.patrol_last_move_time > 5.0:  # æ¯5ç§’ç§»å‹•ä¸€æ¬¡
        self.patrol_last_move_time = current_time
            
        # éš¨æ©Ÿé¸æ“‡ä¸€å€‹æ–¹å‘
        directions = ["forward", "backward", "left", "right"]
        direction = random.choice(directions)
            
        self.logger.info(f"å·¡é‚æ¨¡å¼: ç§»å‹•æ–¹å‘ {direction}")
        self.movement_controller.move(direction)
            
        # çŸ­æš«ç§»å‹•å¾Œåœæ­¢
        time.sleep(1.0)
        self.movement_controller.stop()
    
def _update_surveillance_mode(self, vision_data):
    """æ›´æ–°ç›£è¦–æ¨¡å¼
        
    Args:
        vision_data (dict): è¦–è¦ºç³»çµ±æä¾›çš„æœ€æ–°æ•¸æ“š
    """
    # æª¢æŸ¥æ˜¯å¦æª¢æ¸¬åˆ°äººè‡‰
    face_detected = vision_data.get("face_detected", False)
    recognized_person = vision_data.get("recognized_person", "")
    confidence = vision_data.get("confidence", 0.0)
        
    # æª¢æŸ¥æ˜¯å¦éœ€è¦æš«åœå­¸ç”Ÿè­‰æª¢æ¸¬
    current_time = time.time()
    if current_time < self.student_id_detection_pause_until:
        # æš«åœå­¸ç”Ÿè­‰æª¢æ¸¬
        return
        
    # ç”¨å½©è‰²æ—¥èªŒè¼¸å‡ºäººè‡‰æª¢æ¸¬çµæœ
    # Use colored log output for face detection results
    if face_detected:
        if recognized_person and recognized_person != "unknown":
            self.logger.info(f"{COLORS['GREEN']}[FACE DETECTED] è­˜åˆ¥åˆ°å·²çŸ¥äººå“¡: {recognized_person}, ç½®ä¿¡åº¦: {confidence:.2f}{COLORS['RESET']}")
            self.logger.info(f"{COLORS['GREEN']}[FACE DETECTED] Recognized known person: {recognized_person}, confidence: {confidence:.2f}{COLORS['RESET']}")
        else:
            self.logger.info(f"{COLORS['RED']}[FACE DETECTED] è­˜åˆ¥åˆ°æœªçŸ¥äººå“¡, ç½®ä¿¡åº¦: {confidence:.2f}{COLORS['RESET']}")
            self.logger.info(f"{COLORS['RED']}[FACE DETECTED] Detected unknown person, confidence: {confidence:.2f}{COLORS['RESET']}")
            
    # å¦‚æœæª¢æ¸¬åˆ°äººè‡‰ä½†ä¸æ˜¯å·²çŸ¥äººå“¡
    if face_detected and (not recognized_person or recognized_person == "unknown"):
        if not self.surveillance_intruder_detected:
            self.logger.warning(f"{COLORS['BOLD']}{COLORS['RED']}[ALARM] ç›£è¦–æ¨¡å¼: æª¢æ¸¬åˆ°æœªçŸ¥äººå“¡{COLORS['RESET']}")
            self.logger.warning(f"{COLORS['BOLD']}{COLORS['RED']}[ALARM] Surveillance mode: Unknown person detected{COLORS['RESET']}")
                
            # è¨­ç½®çœ¼ç›é¡è‰²ç‚ºç´…è‰²
            self.logger.info(f"{COLORS['RED']}[EYE COLOR] è¨­ç½®çœ¼ç›é¡è‰²ç‚ºç´…è‰²{COLORS['RESET']}")
            self.logger.info(f"{COLORS['RED']}[EYE COLOR] Setting eye color to red{COLORS['RESET']}")
            self.servo_controller.set_eye_color("red")
                
            # å•Ÿå‹•è­¦å ±
            self.alarm_active = True
            self.logger.warning(f"{COLORS['RED']}[ALARM] å•Ÿå‹•è­¦å ±ç‹€æ…‹{COLORS['RESET']}")
            self.logger.warning(f"{COLORS['RED']}[ALARM] Activating alarm state{COLORS['RESET']}")
                
            # èˆ‰èµ·æ‰‹è‡‚
            self.logger.info(f"{COLORS['MAGENTA']}[ARM MOVEMENT] èˆ‰èµ·æ‰‹è‡‚{COLORS['RESET']}")
            self.logger.info(f"{COLORS['MAGENTA']}[ARM MOVEMENT] Raising arms{COLORS['RESET']}")
            self.servo_controller.raise_arms()
                
            # å•Ÿå‹•æ¿€å…‰
            self.logger.info(f"{COLORS['CYAN']}[LASER] å•Ÿå‹•æ¿€å…‰æŒ‡ç¤ºå™¨{COLORS['RESET']}")
            self.logger.info(f"{COLORS['CYAN']}[LASER] Activating laser pointer{COLORS['RESET']}")
            self.servo_controller.activate_laser()
                
            # æ’­æ”¾è­¦å ±è²
            self.logger.info(f"{COLORS['RED']}[ALARM] æ’­æ”¾è­¦å ±è²{COLORS['RESET']}")
            play_sound(self.alarm_sound_path)
                
            # è¨­ç½®å€’è¨ˆæ™‚
            self.surveillance_countdown = 10  # 10ç§’å€’è¨ˆæ™‚
            self.surveillance_intruder_detected = True
            self.logger.info(f"{COLORS['YELLOW']}[COUNTDOWN] é–‹å§‹10ç§’å€’è¨ˆæ™‚{COLORS['RESET']}")
                
            # å»£æ’­è­¦å ±æ¶ˆæ¯åˆ°å‰ç«¯
            message = {
                "type": "recognition_result",
                "data": {
                    "recognized": False,
                    "message": "æª¢æ¸¬åˆ°æœªçŸ¥äººå“¡",
                    "countdown": self.surveillance_countdown,
                    "confidence": confidence,
                    "emoji": "ğŸš¨",
                    "eye_color": "red"
                }
            }
            
            # å¦‚æœæœ‰WebSocketæœå‹™å™¨å¯¦ä¾‹ï¼Œå»£æ’­è­˜åˆ¥çµæœ
            if hasattr(self, "websocket_server") and self.websocket_server:
                self.logger.info(f"{COLORS['BLUE']}[WEBSOCKET] å»£æ’­è­¦å ±æ¶ˆæ¯åˆ°å‰ç«¯{COLORS['RESET']}")
                self.logger.info(f"Broadcasting alarm message to frontend: {message}")
                self.websocket_server.broadcast_status(message)
                self.logger.info("å·²å»£æ’­è­¦å ±æ¶ˆæ¯åˆ°å‰ç«¯")
            
        # æ›´æ–°å€’è¨ˆæ™‚
        if self.surveillance_countdown > 0:
            self.surveillance_countdown -= 1
            
            # ä½¿ç”¨å½©è‰²æ—¥èªŒè¼¸å‡ºå€’è¨ˆæ™‚ä¿¡æ¯
            self.logger.info(f"{COLORS['YELLOW']}[COUNTDOWN] è­¦å ±å€’è¨ˆæ™‚: {self.surveillance_countdown}ç§’{COLORS['RESET']}")
            self.logger.info(f"{COLORS['YELLOW']}[COUNTDOWN] Alarm countdown: {self.surveillance_countdown} seconds{COLORS['RESET']}")
            
            # å»£æ’­å€’è¨ˆæ™‚æ¶ˆæ¯åˆ°å‰ç«¯
            message = {
                "type": "recognition_result",
                "data": {
                    "recognized": False,
                    "message": f"è­¦å ±å€’è¨ˆæ™‚: {self.surveillance_countdown}",
                    "countdown": self.surveillance_countdown,
                    "confidence": confidence,
                    "emoji": "ğŸš¨",
                    "eye_color": "red"
                }
            }
            
            # å¦‚æœæœ‰WebSocketæœå‹™å™¨å¯¦ä¾‹ï¼Œå»£æ’­è­˜åˆ¥çµæœ
            if hasattr(self, "websocket_server") and self.websocket_server:
                self.logger.info(f"{COLORS['BLUE']}[WEBSOCKET] å»£æ’­å€’è¨ˆæ™‚æ¶ˆæ¯åˆ°å‰ç«¯{COLORS['RESET']}")
                self.websocket_server.broadcast_status(message)
                
            # å¦‚æœå€’è¨ˆæ™‚çµæŸï¼ŒåŸ·è¡Œé¡å¤–æ“ä½œ
            if self.surveillance_countdown == 0:
                self.logger.warning(f"{COLORS['BOLD']}{COLORS['RED']}[ALARM] ç›£è¦–æ¨¡å¼: è­¦å ±å€’è¨ˆæ™‚çµæŸ{COLORS['RESET']}")
                self.logger.warning(f"{COLORS['BOLD']}{COLORS['RED']}[ALARM] Surveillance mode: Alarm countdown ended{COLORS['RESET']}")
                
                    
                    # é€™è£¡å¯ä»¥æ·»åŠ é¡å¤–çš„è­¦å ±æ“ä½œ
                    # ä¾‹å¦‚ç™¼é€é€šçŸ¥ã€æ‹ç…§ç­‰
        
        # å¦‚æœæ²’æœ‰æª¢æ¸¬åˆ°äººè‡‰ï¼Œä½†ä¹‹å‰æœ‰æª¢æ¸¬åˆ°å…¥ä¾µè€…
        elif not face_detected and self.surveillance_intruder_detected:
            # å…¥ä¾µè€…é›¢é–‹äº†ï¼Œä½†å¦‚æœè­¦å ±ç‹€æ…‹ä»ç„¶æ´»èºï¼Œå‰‡ä¿æŒç´…è‰²ç‹€æ…‹
            if not self.alarm_active:
                self.servo_controller.set_eye_color("green")
                self.servo_controller.lower_arms()
                self.servo_controller.deactivate_laser()
                self.surveillance_intruder_detected = False
                self.surveillance_countdown = 0
                
                # å»£æ’­å®‰å…¨æ¶ˆæ¯åˆ°å‰ç«¯
                message = {
                    "type": "recognition_result",
                    "data": {
                        "recognized": False,
                        "message": "æ²’æœ‰äººåœ¨ç•«é¢ä¸­",
                        "countdown": 0,
                        "confidence": 0.0,
                        "emoji": "ğŸ˜Š",
                        "eye_color": "green"
                    }
                }
                
                # å¦‚æœæœ‰WebSocketæœå‹™å™¨å¯¦ä¾‹ï¼Œå»£æ’­è­˜åˆ¥çµæœ
                if hasattr(self, "websocket_server") and self.websocket_server:
                    self.logger.info(f"å»£æ’­å®‰å…¨æ¶ˆæ¯åˆ°å‰ç«¯: {message}")
                    self.logger.info(f"Broadcasting safety message to frontend: {message}")
                    self.websocket_server.broadcast_status(message)
                    self.logger.info("å·²å»£æ’­å®‰å…¨æ¶ˆæ¯åˆ°å‰ç«¯")
            else:
                # è­¦å ±ç‹€æ…‹ä»ç„¶æ´»èºï¼Œä¿æŒç´…è‰²ç‹€æ…‹
                self.logger.info("è­¦å ±ç‹€æ…‹ä»ç„¶æ´»èºï¼Œä¿æŒç´…è‰²ç‹€æ…‹")
                self.logger.info("Alarm is still active, maintaining red state")
                self.surveillance_intruder_detected = True  # ä¿æŒå…¥ä¾µè€…æ¨™èªŒ
    
    def clear_alarm(self):
        """è§£é™¤è­¦å ±ç‹€æ…‹
        
        å°‡è­¦å ±ç‹€æ…‹è¨­ç½®ç‚ºéæ´»èºï¼Œä¸¦å°‡çœ¼ç›é¡è‰²è¨­ç½®ç‚ºç¶ è‰²
        """
        self.logger.info("è§£é™¤è­¦å ±ç‹€æ…‹")
        self.logger.info("Clearing alarm state")
        
        # è¨­ç½®è­¦å ±ç‹€æ…‹ç‚ºéæ´»èº
        self.alarm_active = False
        self.surveillance_intruder_detected = False
        self.surveillance_countdown = 0
        
        # è¨­ç½®çœ¼ç›é¡è‰²ç‚ºç¶ è‰²
        self.servo_controller.set_eye_color("green")
        self.servo_controller.lower_arms()
        self.servo_controller.deactivate_laser()
        
        # å»£æ’­å®‰å…¨æ¶ˆæ¯åˆ°å‰ç«¯
        message = {
            "type": "recognition_result",
            "data": {
                "recognized": False,
                "message": "è­¦å ±å·²è§£é™¤",
                "countdown": 0,
                "confidence": 0.0,
                "emoji": "ğŸ˜Š",
                "eye_color": "green"
            }
        }
        
        # å¦‚æœæœ‰WebSocketæœå‹™å™¨å¯¦ä¾‹ï¼Œå»£æ’­è­˜åˆ¥çµæœ
        if hasattr(self, "websocket_server") and self.websocket_server:
            self.logger.info(f"å»£æ’­è§£é™¤è­¦å ±æ¶ˆæ¯åˆ°å‰ç«¯: {message}")
            self.logger.info(f"Broadcasting alarm clear message to frontend: {message}")
            self.websocket_server.broadcast_status(message)
            self.logger.info("å·²å»£æ’­è§£é™¤è­¦å ±æ¶ˆæ¯åˆ°å‰ç«¯")
    
    def set_patrol_active(self, active):
        """è¨­ç½®å·¡é‚æ¨¡å¼æ´»å‹•ç‹€æ…‹
        
        Args:
            active (bool): å·¡é‚æ˜¯å¦æ´»å‹•
        """
        self.logger.info(f"è¨­ç½®å·¡é‚æ¨¡å¼æ´»å‹•ç‹€æ…‹ç‚º: {active}")
        self.logger.info(f"Setting patrol active state to: {active}")
        self.patrol_active = active
        
        # å¦‚æœå•Ÿå‹•å·¡é‚ï¼Œç¢ºä¿æ¨¡å¼è¨­ç½®ç‚ºå·¡é‚æ¨¡å¼
        if active and self.current_mode != RobotMode.PATROL:
            self.set_mode(RobotMode.PATROL)
    
    def get_status(self):
        """ç²å–æ¨¡å¼ç®¡ç†å™¨ç‹€æ…‹
        
        Returns:
            dict: æ¨¡å¼ç®¡ç†å™¨ç‹€æ…‹
        """
        mode_name = self.current_mode.name if self.current_mode else "NONE"
        
        return {
            "current_mode": mode_name,
            "mode_duration": time.time() - self.mode_start_time,
            "alarm_active": self.alarm_active,
            "patrol_active": self.patrol_active
        }
